---
title: "p9120_final_project_customer"
author: "Qihang Wu"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(corrplot)
library(factoextra)
library(gtsummary)

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)

theme_gtsummary_compact()
```


## Import data & EDA
```{r}
# === Import data & preprocessing ===
customer_raw <- fread("./data/marketing_campaign.csv")
customer <- customer_raw %>% select(-c(8, 27:28)) %>% 
  # for missing
  mutate(Income = ifelse(is.na(Income), round(mean(Income, na.rm = TRUE)), Income),
         Age = 2022 - Year_Birth,
         AcceptedComp = ifelse(rowSums(across(starts_with("AcceptedCmp"))) + Response > 0, 1, 0)
         # AcceptedCmp = sum(across(starts_with("AcceptedCmp"))),
         ) %>% 
  select(1, 27, 3:8, 25, 9:14, 15, 28, 16:19) %>% 
  mutate_at(c(3:4, 9, 17), .funs = ~as.factor(.))

# === EDA ===
# Check correlation
check_cor <- model.matrix(~., customer)[, -1]
corrplot(cor(check_cor[, -1]), method = "circle", type = "full",
         tl.cex = 0.75, tl.col = "black")

# Some demogrpahics
customer %>% 
  group_by(Education, Marital_Status) %>% 
  summarise(tot = n()) %>% 
  ggplot(aes(x = tot, y = Marital_Status, fill = Education)) +
  geom_bar(stat = "identity") + theme_bw() +
  scale_fill_brewer(palette = "RdYlBu") +
  labs(
    x = "Number of participants",
    y = "Marital Status",
    title = "Frequency by Marital Status & Education"
  )
```


## Clustering
```{r}
# === K-means === 
# a quick try of k-means on continuous unselected vars
set.seed(202212)
customer_scale <- scale(customer[, c(5:8, 10:16, 18:21)])

fviz_nbclust(customer_scale, FUNcluster = kmeans, 
             method = "gap_stat", iter.max = 50)
km <- kmeans(customer_scale, centers = 3, nstart = 20)
fviz_cluster(list(data = customer_scale, cluster = km$cluster),
             ellipse.type = "convex", geom = "point",
             labelsize = 5, palette = "Dark2") + theme_bw()

# Demographic for each cluster
tbl_summary(by = clust,
            data = customer %>% 
              mutate(clust = km$cluster,
                     Complain = factor(Complain, levels = c(0, 1), labels = c("No", "Yes")),
                     AcceptedComp = factor(AcceptedComp, levels = c(0, 1), labels = c("No", "Yes")),
                     clust = factor(clust, levels = c(1:3), labels = c("Cluster 1", "Cluster 2", "Cluster 3"))) %>% 
              select(-1),
            label = list(Marital_Status ~ "Marital Status", Kidhome ~ "Number of Kids",
                         Teenhome ~ "Number of Teens", Recency ~ "Number of Days Since Last Purchase",
                         Complain ~ "Complaint (in last 2 yrs)",
                         
                         # products
                         MntWines ~ "Wine", MntFruits ~ "Fruits", MntMeatProducts ~ "Meat Products",
                         MntFishProducts ~ "Fish Products", MntSweetProducts ~ "Sweet Products",
                         MntGoldProds ~ "Gold Products", 
                         
                         # campaign & place
                         NumDealsPurchases ~ "Number of Purchases made with a discount", 
                         AcceptedComp ~ "Customer Accepted the Offer",
                         NumWebPurchases ~ "Through the Company's Website", NumCatalogPurchases ~ "Using a Catelogue",
                         NumStorePurchases ~ "Directlt in Stores", NumWebVisitsMonth ~ "Website Visits (in last month)")) %>% 
  add_p(all_categorical() ~ "chisq.test") %>% add_overall() %>% 
  modify_table_styling(footnote = "Amount spent on a type of product in last two years",
                       rows = (label == "Wine"), columns = label) %>% 
  modify_table_styling(footnote = "Number of purchases made through a way",
                       rows = (label == "Through the Company's Website"),
                       columns = label) %>% 
  modify_caption("**Demographics of Customers for each K-means Cluster (n=2240)**") %>% 
  bold_labels()
```







